<html lang="es">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <title>Consulta Vehicular Integral</title>
   
 
</head>
<body>
  <a href="https://wa.me/51949319753?text=Hola%2C%20necesito%20ayuda%20con%20el%20informe%20vehicular"
   class="whatsapp-float" target="_blank" title="¬øNecesitas ayuda?">
  <div class="whatsapp-content">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="whatsapp-icon">
      <path fill="white" d="M380.9 97.1C339.3 55.5 282.4 32 222.6 32c-121.1 0-219.6 98.5-219.6 219.6 0 38.6 10 76.3 29 109.3L4.4 480l123.4-32.4c31.9 17.5 67.8 26.8 104.8 26.8h.1c121.1 0 219.6-98.5 219.6-219.6 0-59.8-23.5-116.7-66.4-158.7zM222.6 438.6c-30.2 0-59.9-8.1-85.7-23.4l-6.1-3.6-73.2 19.2 19.5-71.1-4.5-7c-17.8-27.7-27.1-59.9-27.1-93 0-94.2 76.6-170.8 170.8-170.8 45.7 0 88.7 17.8 121 50.1s50.1 75.3 50.1 121c0 94.1-76.6 170.6-170.8 170.6zm101.2-130.1c-5.5-2.8-32.7-16.1-37.8-17.9-5.1-1.9-8.8-2.8-12.5 2.8s-14.4 17.9-17.7 21.6c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66.1-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7s-12.5-30-17.1-41.1c-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3s19.9 53.7 22.7 57.4c2.8 3.7 39.2 60 95.1 84.2 13.3 5.7 23.7 9.1 31.8 11.6 13.4 4.3 25.6 3.7 35.2 2.2 10.7-1.6 32.7-13.4 37.3-26.4 4.6-13.1 4.6-24.3 3.2-26.3-1.3-2.1-5-3.3-10.5-6.1z"/>
    </svg>
    <span>¬øNecesitas ayuda?</span>
  </div>
</a>
  <div class="main-content"> 
<!-- üîπ Contenedor de Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="openTab(event, 'vehicular')">üöò Consulta Vehicular</button>
  <button class="tab-btn" onclick="openTab(event, 'propietario')">üë§ Consulta Propietario</button>
</div>
<div id="vehicular" class="tab-content active"> 
  <div class="container">
    <div class="header">
      <img src="principal.png" alt="Logo Consulta Vehicular">
      <h1> </h1>
      <p> ¬°Consulta en segundos el historial de cualquier veh√≠culo con solo su placa!     </p>
    </div>
<div class="input-search">
  <input type="text" id="placa" placeholder="    Ejemplo: ABC123" />
</div>
<button onclick="consultar()">Consultar</button>
 
<button onclick="descargarPDF()">üìÑ Descargar PDF</button>
<button id="btn-whatsapp" onclick="compartirWhatsApp()" style="background-color: #25d366;">
  üì≤ Compartir por WhatsApp
</button><div class="estado-resumen">
  <!-- SOAT -->
  <span class="badge badge-ok">SOAT Vigente</span>
  <span class="badge badge-expired">SOAT Vencido</span>

  <!-- Revisi√≥n T√©cnica -->
  <span class="badge badge-ok">Revisi√≥n Vigente</span>
  <span class="badge badge-expired">Revisi√≥n Vencida</span>

  <!-- Papeletas -->
  <span class="badge badge-alert">Multas Pendientes</span>
  <span class="badge badge-clear">Sin Multas</span>
</div>
     <div id="soat-vehiculo"   style="display:none;">
       
      <div id="soat-info" class="tarjeta"></div>
       
      <div id="vehiculo-info" class="tarjeta"></div>
    </div>
    <div id="resultado-revision" class="tarjeta"></div>
    <div id="resultadoSiniestro" class="tarjeta"></div>
    <div id="resultadoSutran" class="tarjeta"></div>
    
     <div id="resultadoOrdenCaptura" class="tarjeta"></div>
     <div id="resultado-impuesto" class="tarjeta"></div>
     <div id="resultado-atu" class="section"></div>
    <div id="resultado-infogas" class="section"></div>
     <div id="resultado-lima" class="section"></div>
    <div id="resultado-callao" class="section"></div>
     <div id="resultado-arequipa" class="section"></div>
    <div id="resultado-huancayo" class="section"></div>
    <div id="resultado-tarapoto" class="section"></div>
     <div id="resultado-tacna" class="section"></div> <!-- NUEVA SECCI√ìN -->  
    <div id="resultado" class="section"></div>
     
  </div>
  </div>

<div id="propietario" class="tab-content">


  <h1>Consulta de Asientos SUNARP</h1>

  <form id="formConsulta" class="buscador">
    <div class="campo">
      <label for="placa">Placa</label>
      <input type="text" id="placaa" name="placa" required placeholder="Ej: ABC123">
    </div>
    <div class="campo">
      <label for="ciudad">Oficina Registral</label>
      <select id="ciudad" name="ciudad" required>
        <option value="">Seleccione...</option>
        <option value="ABANCAY">ABANCAY</option>
       <option value="ANDAHUAYLAS">ANDAHUAYLAS</option>
       <option value="AREQUIPA">AREQUIPA</option> 
       <option value="AYACUCHO">AYACUCHO</option>
       <option value="BAGUA">BAGUA</option>
      <option value="BARRANCA">BARRANCA</option>
        <option value="CAJAMARCA">CAJAMARCA</option>
       <option value="CALLAO">CALLAO</option>
       <option value="CAMANA">CAMANA</option>
       <option value="CASMA">CASMA</option>
       <option value="CASTILLA_APLAO">CASTILLA_APLAO</option>
       <option value="CA√ëETE">CA√ëETE</option>
       <option value="CHACHAPOYAS">CHACHAPOYAS</option>
       <option value="CHEPEN">CHEPEN</option>
       <option value="CHICLAYO">CHICLAYO</option>
       <option value="CHIMBOTE">CHIMBOTE</option>
       <option value="CHINCHA">CHINCHA</option>
       <option value="CHOTA">CHOTA</option>
       <option value="CUSCO">CUSCO</option>
       <option value="ESPINAR">ESPINAR</option>
       <option value="HUACHO">HUACHO</option>
      <option value="HUAMANCHUCO">HUAMANCHUCO</option>
      <option value="HUANCAVELICA">HUANCAVELICA</option>
      <option value="HUANCAYO">HUANCAYO</option>
      <option value="HUANTA">HUANTA</option>
       <option value="HUANUCO">HUANUCO</option>
        <option value="HUARAL">HUARAL</option>
      <option value="HUARAZ">HUARAZ</option>
      <option value="ICA">ICA</option>
       <option value="ILO">ILO</option>
        <option value="IZLAY_MOLLENDO">IZLAY_MOLLENDO</option>
         <option value="JAEN">JAEN</option>
          <option value="JULIACA">JULIACA</option>
           <option value="LA MERCED(SELVA CENTRAL)">LA MERCED(SELVA CENTRAL)</option>
        <option value="LIMA">LIMA</option>
        <option value="MADRE DE DIOS">MADRE DE DIOS</option>
        <option value="MAYNAS">MAYNAS</option>
        <option value="MOQUEGUA">MOQUEGUA</option>
        <option value="NAZC">NAZCA</option>
        <option value="OTUZCO">OTUZCO</option>
        <option value="PASCO">PASCO</option>
<option value="PISCO">PISCO</option>
<option value="PIURA">PIURA</option>
        <option value="PUCALLPA">PUCALLPA</option>
        <option value="PUNO">PUNO</option>
        <option value="QUILLABAMBA">QUILLABAMBA</option>
        <option value="SAN PEDRO">SAN PEDRO</option>
        <option value="SATIPO">SATIPO</option>
        <option value="SULLANA">SULLANA</option>
        <option value="TACNA">TACNA</option>
        <option value="TARMA">TARMA</option>
        <option value="TINGO MARIA">TINGO MARIA</option>
        <option value="TRUJILLO">TRUJILLO</option>
        <option value="TUMBES">TUMBES</option>
      </select>
    </div>
    <button type="submit">üîç Consultar</button>
  </form>

  <div id="resultado-PROPIETARIOS"></div>

  <!-- Modal global -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2>Detalles</h2>
      <div id="modal-body"></div>
      <button class="modal-close">Cerrar</button>
    </div>
  </div>



</div>
  </div>
  <div class="footer">
    <p>¬© 2025 Consulta Vehicular. Todos los derechos reservados By PaginasWebPro.</p>
    <p>Contacto: <a href="https://wa.me/51926838543?text=Hola%2C%20necesito%20ayuda%20con%20el%20informe%20vehicular">israelsq03@gmail.com</a></p>
  </div>
<!-- Ventana flotante -->
<div id="overlayCarga"></div>

<div id="ventanaCarga">
  ‚è≥ Se est√° realizando la consulta...
</div>
  <script>
    async function consultar() {
      if (sessionStorage.getItem("yaConsultado")) {
  alert("Solo se permite una consulta por sesi√≥n. Ser√°s redirigido al inicio.");
  window.location.href = "index.html"; // Redirige al inicio
  return;
}
sessionStorage.setItem("yaConsultado", "true"); // Marca como ya consultado
  document.getElementById("overlayCarga").style.display = "block";
  document.getElementById("ventanaCarga").style.display = "block";

  setTimeout(() => {
    document.getElementById("overlayCarga").style.display = "none";
    document.getElementById("ventanaCarga").style.display = "none";
  }, 3000); // 3 segundos
  
 
        
      const placa = document.getElementById("placa").value.trim().toUpperCase();
         const limaDiv = document.getElementById("resultado-lima");
      const resultadoSutran = document.getElementById('resultadoSutran');
      const resultadoSiniestro = document.getElementById('resultadoSiniestro');
  
     
  
      const callaoDiv = document.getElementById("resultado-callao");
        const resultado = document.getElementById('resultado');
      
        limaDiv.innerHTML = '<h2>Resultados SAT Lima</h2><div class=" mensaje-infoo"><div class="loader"></div></div>';
    callaoDiv.innerHTML = '<h2>Resultados SAT Callao</h2><div class=" mensaje-infoo"><div class="loader"></div></div>';
   
 // SAT tacna


      // SAT Lima
 
  
      fetch("/api/consultar-lima", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ placa })
      }).then(res => res.json()).then(data => {
        if (!data.success || !data.results?.length) {
     limaDiv.innerHTML = '<h2>Resultados SAT Lima</h2><div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas.</div>';
          return;
        }
 let html = '<h2>Resultados SAT Lima</h2><div class="tabla-responsive"><table><tr>' +
        '<th>Placa</th><th>Reglamento</th><th>Falta</th><th>Documento</th>' +
        '<th>Fecha</th><th>Importe</th><th>Gastos</th><th>Descuentos</th>' +
        '<th>Deuda</th><th>Estado</th></tr>';
      data.results.forEach(r => {
        html += `<tr>
          <td>${r.Placa}</td><td>${r.Reglamento}</td><td>${r.Falta}</td>
          <td>${r.Documento}</td><td>${r.FechaInfraccion}</td>
          <td>${r.Importe}</td><td>${r.Gastos}</td><td>${r.Descuentos}</td>
          <td>${r.Deuda}</td><td>${r.Estado}</td></tr>`;
      });
      html += '</table></div>';
      limaDiv.innerHTML = html;
    }).catch(() => {
      limaDiv.innerHTML = '<h2>Resultados SAT Lima</h2><div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas..</div>';
    });

 resultadoSutran.textContent = 'Consultando infracciones SUTRAN...';
      resultadoSiniestro.textContent = 'Consultando siniestros SBS...';
 resultadoSiniestro.innerHTML = ' <div class="bloque-siniestro"><h2>üöß Resultados SBS (Siniestros)</h2><div class="mensaje-info">Consultando siniestros SBS...</div>';

fetch('/siniestro', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ placa })
})
.then(res => res.json())
.then(data => {
  if (data.resultado) {
    const { placa, fechaConsulta, actualizadoA, cantidadAccidentes } = data.resultado;
    resultadoSiniestro.innerHTML = `
       <div class="bloque-siniestro"><h2>üöß Resultados SBS (Siniestros)</h2>
      <div class="mensaje-info">
        <strong>üöò Placa:</strong> ${placa}<br>
        <strong>üìÖ Fecha de Consulta:</strong> ${fechaConsulta}<br>
        <strong>üìå Actualizado a:</strong> ${actualizadoA}<br>
        <strong>‚ö†Ô∏è Accidentes Reportados:</strong> ${cantidadAccidentes}
      </div>`;
  } else {
    resultadoSiniestro.innerHTML = `
       <div class="bloque-siniestro"><h2>üöß Resultados SBS (Siniestros)</h2>
      <div class="mensaje-info">No se encontr√≥ informaci√≥n en SBS.</div>`;
  }
})
.catch(err => {
  resultadoSiniestro.innerHTML = ' <div class="bloque-siniestro"><h2>üöß Resultados SBS (Siniestros)</h2><div class="mensaje-info">Error al consultar siniestros SBS.</div>';
  console.error(err);
});

// Consultar SUTRAN
resultadoSutran.innerHTML = ' <div class="bloque-siniestro"><h2>üöå Resultados SUTRAN</h2><div class="mensaje-info">Consultando infracciones SUTRAN...</div>';

fetch('/consultar', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ placa })
})
.then(res => res.json())
.then(data => {
  resultadoSutran.innerHTML = `
    <h2>üöå Resultados SUTRAN</h2>
    <div class="mensaje-info">
      ${data.resultado || 'No se encontr√≥ informaci√≥n en SUTRAN.'}
    </div>`;
})
.catch(err => {
  resultadoSutran.innerHTML = '<h2>üöå Resultados SUTRAN</h2><div class="mensaje-info">Error al consultar SUTRAN.</div>';
  console.error(err);
});

// Consultar √ìrdenes de Captura
resultadoOrdenCaptura.innerHTML = ' <div class="bloque-siniestro"><h2>üõë Resultados SAT √ìrdenes de Captura</h2><div class="mensaje-info">‚è≥ Consultando...</div>';

fetch('/orden-captura', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ placa })
})
.then(res => res.json())
.then(data => {
  if (Array.isArray(data.resultado) && data.resultado.length > 0) {
    // Mensaje de cabecera
    const mensajeCabecera = `
      <p><strong>El veh√≠culo de placa ${data.resultado[0].placa} TIENE ORDEN DE CAPTURA por los siguientes conceptos:</strong></p>
    `;

    // Tabla de resultados
    const tablaResultados = `
      <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; text-align:left;">
        <thead style="background:#f5f5f5;">
          <tr>
            <th>üìÑ Documento</th>
            <th>üìÖ A√±o</th>
            <th>üìë Concepto</th>
            <th>üîÑ Placa Original</th>
            <th>üìù Referencia</th>
            <th>üí∞ Monto en Captura (S/)</th>
          </tr>
        </thead>
        <tbody>
          ${data.resultado.map(r => `
            <tr>
              <td>${r.documento}</td>
              <td>${r.anio || '‚Äî'}</td>
              <td>${r.concepto}</td>
              <td>${r.placaOriginal}</td>
              <td>${r.referencia || '‚Äî'}</td>
              <td>${r.monto}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    resultadoOrdenCaptura.innerHTML = `
      <div class="bloque-siniestro">
        <h2>üõë Resultados SAT √ìrdenes de Captura</h2>
        <div class="mensaje-info">
          ${mensajeCabecera}
          ${tablaResultados}
        </div>
      </div>
    `;
  } else {
    resultadoOrdenCaptura.innerHTML = `
       <div class="bloque-siniestro"><h2>üõë Resultados SAT √ìrdenes de Captura</h2>
      <div class="mensaje-info">${data.resultado}</div>`;
  }
})
.catch(err => {
  resultadoOrdenCaptura.innerHTML = ' <div class="bloque-siniestro"><h2>üõë Resultados SAT √ìrdenes de Captura</h2><div class="mensaje-info">Error al consultar √≥rdenes de captura SAT.</div>';
  console.error(err);
});
 
      // SAT Callao
     fetch("/api/consultar-callao", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa })
    }).then(res => res.json()).then(data => {
      if (!data.success || !data.resultados?.length) {
        callaoDiv.innerHTML = '<h2>Resultados SAT Callao</h2><div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas.</div>';
        return;
      }

      let html = '<h2>Resultados SAT Callao</h2><div class="tabla-responsive"><table><tr>' +
        '<th>C√≥digo</th><th>N¬∞ Papeleta</th><th>Fecha Infracci√≥n</th>' +
        '<th>Total Infracci√≥n</th><th>Beneficio</th><th>Descuento Web</th>' +
        '<th>Cuotas</th><th>Detalle</th><th>Fraccionar</th></tr>';

      data.resultados.forEach(r => {
        if (!r.Codigo || r.Codigo.toLowerCase().includes("valor") || r.Codigo.toLowerCase().includes("emisi√≥n")) return;
        html += `<tr>
          <td>${r.Codigo}</td><td>${r.NumeroPapeleta}</td><td>${r.FechaInfraccion}</td>
          <td>${r.Total}</td><td>${r.Beneficio}</td><td>${r.DescuentoWeb}</td>
          <td>${r.Cuota}</td><td>${r.Detalle}</td><td>${r.Fraccionar}</td>
        </tr>`;
      });

      html += '</table></div>';
      callaoDiv.innerHTML = html;
    }).catch(() => {
      callaoDiv.innerHTML = '<h2>Resultados SAT Callao</h2><div class="mensaje-error">Error al consultar.</div>';
    });
 

 

    


      resultado.innerHTML = 'Consultando...';

      const endpoints = [
        { ciudad: 'Chiclayo', url: '/api/chiclayo' },
        { ciudad: 'Hu√°nuco', url: '/api/huanuco' },
          { ciudad: 'Chachapoyas', url: '/api/chachapoyas' }, // ‚úÖ Nuevo
          
           { ciudad: 'Cajamarca', url: '/api/cajamarca' },
           { ciudad: 'Cusco', url: '/api/cusco' }, // ‚úÖ Nuevo
             { ciudad: 'Ica', url: "/api/ica" },
            
           { ciudad: 'Andahuaylas',url: "/api/andahuaylas"},
             { ciudad: 'Puno', url: '/api/puno' }, 
              { ciudad: 'Pucallpa', url: '/api/pucallpa' },
      ];

      resultado.innerHTML = '';

      const contenedores = {};
endpoints.forEach(endpoint => {
  const div = document.createElement('div');
  div.className = 'result-box';
  div.innerHTML = `<h2>${endpoint.ciudad}</h2><div class="tarjeta"><div class="loader"></div></div>`;
  resultado.appendChild(div);
  contenedores[endpoint.ciudad] = div;
});

// Lanzar todas las consultas en paralelo
const promesas = endpoints.map(endpoint =>
  fetch(endpoint.url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ placa })
  })
  .then(async res => {
  const contentType = res.headers.get("content-type");
  if (contentType && contentType.includes("application/json")) {
    return await res.json();
  } else {
    const text = await res.text();
    return { html: text }; // lo tratamos como si viniera en formato html directo
  }
})
.then(data => {
  const contenedor = contenedores[endpoint.ciudad];

  if (data.tienePapeletas === false) {
    contenedor.innerHTML = `<h2>Resultados SAT ${endpoint.ciudad}</h2><div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas.</p>`;
  } else if (data.tienePapeletas === true) {
    contenedor.innerHTML = `<h2>${endpoint.ciudad}</h2><p style="color: red;">üö® Tiene papeletas registradas.</p>`;
  } else if (data.html) {
    // Si contiene HTML como respuesta
    if (
      data.html.includes("No hay papeletas") ||
      data.html.includes("no se encontraron resultados")
    ) {
      contenedor.innerHTML = `<h2>Resultados SAT  ${endpoint.ciudad}</h2><div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas.</p>`;
    } else {
      contenedor.innerHTML = `${data.html}`;
    } 
  } else {
    contenedor.innerHTML = `<h2>${endpoint.ciudad}</h2> <div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas.</p>`;
  }
})
.catch(err => {
  contenedores[endpoint.ciudad].innerHTML = `<h3>${endpoint.ciudad}</h3><p style="color: red;">‚ùå Error consultando.</p>`;
})
);

Promise.allSettled(promesas);
 
    
   
    
      // SOAT + Info t√©cnica
       consultarInfogas(placa);
      consultarSOATyVehiculo(placa);
      consultarRevisionTecnica(placa);
      impuestovehicular(placa) ;
      
      consultarSatProvincias(placa); // Tarapoto y Huancayo
      consultarATU(placa);
       consultarequipa(placa);
         consultarTacna(placa);
        
  
} 
async function consultarequipa(placa) {
  document.getElementById("resultado-arequipa").innerHTML =
    `<h2>SAT Arequipa</h2><div class="tarjeta"><div class="loader"></div></div>`;

  try {
    const res = await fetch("https://www.consultavehicular.services/consultar-arequipa", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa })
    });

    const data = await res.json();

    if (!data.exito) {
      // üëâ Aqu√≠ usamos el mismo estilo que mostraste
      document.getElementById("resultado-arequipa").innerHTML = `
        <h2>Resultados SAT Arequipa</h2>
        <div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas para la placa <strong>${placa}</strong>.</div>
      `;
    } else {
      let html = "<h2>Resultados SAT Arequipa</h2><h4>Las infracciones de la placa consultada son:</h4>";
      html += "<table><thead><tr>";
      data.encabezados.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += "</tr></thead><tbody>";

      data.resultados.forEach(row => {
        html += "<tr>";
        row.forEach(col => {
          html += `<td>${col}</td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("resultado-arequipa").innerHTML = html;
    }
  } catch (err) {
    console.error(err);
    document.getElementById("resultado-arequipa").innerHTML =
      "<p style='color:red;'>Error al conectar con el servidor</p>";
  }
}

 async function impuestovehicular(placa) {
       
      const resultadoDiv = document.getElementById("resultado-impuesto");
      resultadoDiv.innerHTML = ' <div class="bloque-siniestro"><h2>üöòü™ô Impuesto Vehicular(SAT)</h2><div class="mensaje-info">‚è≥ Buscando datos...</div>';

      if (!placa) {
        resultadoDiv.innerHTML = "‚ö†Ô∏è Ingrese una placa.";
        return;
      }

      try {
        const res = await fetch("https://www.consultavehicular.services/consultarr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ placa })
        });
        const data = await res.json();

        if (!data || !data.total) {
          resultadoDiv.innerHTML = "‚ö†Ô∏è No se encontraron resultados.";
          return;
        }

        // Construir tarjeta
        resultadoDiv.innerHTML = ` <div class="bloque-siniestro"><h2>üöòü™ôResultados Impuesto Vehicular(SAT)</h2>
          <div class="card">
            <div class="placaa">üöó Placa: ${data.placa || placa}</div>
            <div class="total">üí∞ Deuda Total: ${data.total}</div>
            <button class="toggle-btn">Ver Detalles</button>
        <div class="detalle">
  <div class="row gridtree-header" style="margin:8px 0; padding:8px; border:1px solid #ddd; background:#f9f9f9; display:flex; justify-content:space-between; align-items:center;">
    <div>
     Papeletas
    </div>
    <div>
      TOTAL:&nbsp;&nbsp;&nbsp;<strong>${data.total}</strong>
    </div>
    <div>
      <a href="#"><i class="toogle fa fa-minus"></i></a>
    </div>
  </div><div class="table-container">
  <table>
                <thead>
                  <tr>
                    <th>Falta</th>
                    <th>Documento</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Deuda</th>
                  </tr>
                </thead>
                <tbody>
                  ${(data.detalle || []).map(d => `
                    <tr>
                      <td>${d.falta}</td>
                      <td>${d.documento}</td>
                      <td>${d.fecha}</td>
                      <td>${d.monto}</td>
                      <td>S/ ${d.estado}</td>
                    </tr>
                  `).join("")}
                </tbody>
              </table></div>
            </div>
          </div>
        `;

        // Agregar evento al bot√≥n
        const btn = resultadoDiv.querySelector(".toggle-btn");
        const detalle = resultadoDiv.querySelector(".detalle");

        btn.addEventListener("click", () => {
          const visible = detalle.style.display === "block";
          detalle.style.display = visible ? "none" : "block";
          btn.textContent = visible ? "Ver Detalles" : "Ocultar Detalles";
        });

      } catch (error) {
        resultadoDiv.innerHTML = `<h2>üöòü™ô Impuesto Vehicular.</h2><div class="mensaje-infoo">üìÑ No se encontraron deudas pendientes.</div>`;
      }
    }

async function consultarInfogas(placa) {
  const infogasDiv = document.getElementById("resultado-infogas");
  infogasDiv.innerHTML = `<h2>‚õΩ Infogas GNV</h2><div class="tarjeta"><div class="loader"></div></div>`;

  // Aviso de espera prolongada
  setTimeout(() => {
    if (document.querySelector("#resultado-infogas .loader")) {
      infogasDiv.innerHTML += `<p style="color: #999;">‚è≥ Consultando Infogas... puede tardar unos segundos.</p>`;
    }
  }, 10000);

  try {
    const res = await fetch("/api/consultar-infogas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa })
    });

    const data = await res.json();

    if (!data.success || !data.resultados || Object.keys(data.resultados).length === 0) {
      infogasDiv.innerHTML = `<h2>‚õΩ Infogas GNV.</h2><div class="mensaje-infoo">üìÑ No se encontraron datos de Infogas.</div>`;
      return;
    }

    const r = data.resultados;
    infogasDiv.innerHTML = `
      <div class="tarjeta">
        <h2>‚õΩ Infogas GNV.</h2>
        <div class="mensaje-info">
          <strong>üöó Placa:</strong> ${placa} <br>
          <strong>‚õΩ Tipo de Combustible:</strong> ${r.tipoCombustible || '-'} <br>
          <strong>‚úÖ Habilitado para consumir:</strong> ${r.habilitado || '-'} <br>
          <strong>üìÑ ¬øTiene Cr√©dito?:</strong> ${r.tieneCredito || '-'} <br>
          <strong>üìÖ Vencimiento Revisi√≥n Anual:</strong> ${r.vencimientoRevisionAnual || '-'} <br>
          <strong>üìÖ Vencimiento de Cilindro:</strong> ${r.vencimientoCilindro || '-'}
        </div>
      </div>
    `;
  } catch (error) {
    infogasDiv.innerHTML = `<h2>‚õΩ Infogas GNV.</h2><div class="mensaje-infoo"> No se encontraron informacion en Infogas..</div>`;
  }
}

 async function consultarTacna(placa) {
  const resultadoDiv = document.getElementById("resultado-tacna");
 
  resultadoDiv.innerHTML = `<h2>SAT Tacna</h2><div class="tarjeta"><div class="loader"></div></div>`;

  try {
    const res = await fetch("/consultartacna", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa }),
    });
    const data = await res.json();

    if (data.mensaje) {
      resultadoDiv.innerHTML = `<p>${data.mensaje}</p>`;
    } else if (Array.isArray(data) && data.length > 0) {
      let tablaHTML = `'<h2>Resultados SAT Tacna</h2> ' +
        <table border="1" cellspacing="0" cellpadding="5">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Estado</th>
              <th>N¬∞ Papeleta</th>
              <th>A√±o</th>
              <th>C√≥d. Infracci√≥n</th>
              <th>Propietario</th>
              <th>DNI Prop.</th>
              <th>Infractor</th>
              <th>DNI Infr.</th>
              <th>Licencia</th>
              <th>Importe</th>
            </tr>
          </thead>
          <tbody>`;

      data.forEach(p => {
        tablaHTML += `
          <tr>
            <td>${p.fecha}</td>
            <td>${p.estado}</td>
            <td>${p.numeroPapeleta}</td>
            <td>${p.anio}</td>
            <td>${p.codInfraccion}</td>
            <td>${p.propietario}</td>
            <td>${p.dniPropietario}</td>
            <td>${p.infractor}</td>
            <td>${p.dniInfractor}</td>
            <td>${p.licencia}</td>
            <td>${p.importe}</td>
          </tr>`;
      });

      tablaHTML += `</tbody></table>`;
      resultadoDiv.innerHTML = `
         
        <div class="tabla-responsive">${tablaHTML}</div>
      `;
    } else {
      resultadoDiv.innerHTML = '<h2>Resultados SAT Tacna</h2><div class="mensaje-infoo">‚ÑπÔ∏è No se encontraron papeletas.</div>';
    }
  } catch (error) {
    resultadoDiv.innerHTML = `<p style="color:red">‚ùå Error al consultar: ${error.message}</p>`;
  }
}
  async function consultarSOATyVehiculo(placa) {
  const soatCont = document.getElementById("soat-info");
  const vehiculoCont = document.getElementById("vehiculo-info");
  document.getElementById("soat-vehiculo").style.display = "block";

  // Mostrar mensajes de carga
  soatCont.innerHTML = `
    <h2>üìÑ Resultados SOAT</h2>
    <div class="mensaje-info">‚è≥ Consultando SOAT...</div>`;
  vehiculoCont.innerHTML = `
    <div class="bloque-siniestro"> <h2>üöò Resultados del Veh√≠culo</h2>
    <div class="mensaje-info">‚è≥ Consultando datos t√©cnicos...</div>`;

  const token = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzODkyMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6ImNvbnN1bHRvciJ9.kcxt3XYtXWWgNZdMnaENUZj-568RMkDRAVqV-DRk73I";

  try {
    const [soatRes, infoRes] = await Promise.all([
      fetch(`https://api.factiliza.com/v1/placa/soat/${placa}`, { headers: { Authorization: token } }).then(r => r.json()),
      fetch(`https://api.factiliza.com/v1/placa/info/${placa}`, { headers: { Authorization: token } }).then(r => r.json())
    ]);

    const soat = soatRes.data;
    const info = infoRes.data;

    // Mostrar resultados SOAT
    if (soat && soat.placa) {
      const estadoIcon = soat.estado === "VIGENTE"
        ? "<span style='color:green;font-weight:bold;'>‚úÖ VIGENTE</span>"
        : "<span style='color:red;font-weight:bold;'>‚ùå NO VIGENTE</span>";

      soatCont.innerHTML = `
        <h2>üìÑ Resultados SOAT</h2>
        <div class="mensaje-info">
          <strong>üöò Placa:</strong> ${soat.placa}<br>
          <strong>üè¢ Aseguradora:</strong> ${soat.nombre_compania}<br>
          <strong>üìÖ Inicio:</strong> ${soat.fecha_inicio}<br>
          <strong>üìÖ Fin:</strong> ${soat.fecha_fin}<br>
          <strong>üìå Estado:</strong> ${estadoIcon}<br>
          <strong>üîñ N¬∞ de P√≥liza:</strong> ${soat.numero_poliza}
        </div>`;
    } else {
      soatCont.innerHTML = `
        <h2>üìÑ Resultados SOAT</h2>
        <div class="mensaje-info">‚ùå No se encontr√≥ informaci√≥n del SOAT.</div>`;
    }

    // Mostrar resultados del veh√≠culo
    if (info && info.placa) {
      vehiculoCont.innerHTML = `
       <div class="bloque-siniestro">  <h2>üöò Resultados del Veh√≠culo</h2>
        <div class="mensaje-info">
          <strong>üöò Placa:</strong> ${info.placa}<br>
          <strong>üè∑Ô∏è Marca:</strong> ${info.marca}<br>
          <strong>üßæ Modelo:</strong> ${info.modelo}<br>
          <strong>üé® Color:</strong> ${info.color}<br>
          <strong>üî¢ Serie:</strong> ${info.serie}<br>
          <strong>üõ†Ô∏è Motor:</strong> ${info.motor}<br>
          <strong>üîç VIN:</strong> ${info.vin}
        </div>`;
    } else {
      vehiculoCont.innerHTML = `
        <div class="bloque-siniestro"> <h2>üöò Resultados del Veh√≠culo</h2>
        <div class="mensaje-info">‚ùå No se encontr√≥ informaci√≥n t√©cnica del veh√≠culo.</div>`;
    }

  } catch (error) {
    soatCont.innerHTML = `
      <div class="bloque-siniestro"> <h2>üìÑ Resultados SOAT</h2>
      <div class="mensaje-info">‚ùå Error SOAT: ${error.message}</div>`;
    vehiculoCont.innerHTML = `
      <div class="bloque-siniestro"> <h2>üöò Resultados del Veh√≠culo</h2>
      <div class="mensaje-info">‚ùå Error Veh√≠culo: ${error.message}</div>`;
  }
}
 async function consultarRevisionTecnica(placa) {
  const revisionDiv = document.getElementById("resultado-revision");

  // Mostrar estado "Consultando..."
  revisionDiv.innerHTML = ` <div class="bloque-siniestro"><h2>üîßRevisi√≥n T√©cnica (MTC)</h2><div class="mensaje-info">‚è≥ Consultando...</div>`;

  try {
    const res = await fetch("/api/consultar-revision", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa })
    });

    const data = await res.json();

    if (data.error || !data.resultados || data.resultados.length === 0) {
      revisionDiv.innerHTML = ` <div class="bloque-siniestro"><h2>Revisi√≥n T√©cnica (MTC)</h2><div class="mensaje-info">‚ÑπÔ∏è No se encontr√≥ informaci√≥n en Revisi√≥n T√©cnica.</div>`;
      return;
    }

    const r = data.resultados[0];
    const estadoColor = (r.resultado || "").toLowerCase().includes("aprobado") ? "green" : "red";

    revisionDiv.innerHTML = `
       <div class="bloque-siniestro"><h2>üîß Revisi√≥n T√©cnica (MTC).</h2>
      <div class="mensaje-info">
         <strong>üìÑ Certificado:</strong> ${r.placa} <br>
         <strong>üöó Placa:</strong> ${r.certificado} <br>
         <strong>üìÖ Fecha de Revisi√≥n:</strong> ${r.fechaRevision} <br>
         <strong>üìÜ Fecha de Vencimiento:</strong> ${r.fechaVencimiento} <br>
        <strong>‚úÖ Resultado:</strong> <span style="color:${estadoColor}; font-weight:bold;">${r.resultado}</span> <br>
         <strong>üè≠ Planta:</strong> ${r.planta} 
      </div>
    `;
  } catch (err) {
    revisionDiv.innerHTML = ` <div class="bloque-siniestro"><h2>üîß Revisi√≥n T√©cnica MTC</h2><div class="mensaje-infoo">‚ÑπÔ∏è Error al consultar revisi√≥n t√©cnica.</div>`;
    console.error(err);
  }
}
 

async function consultarSatProvincias(placa) {
  const tarapotoDiv = document.getElementById("resultado-tarapoto");
  const huancayoDiv = document.getElementById("resultado-huancayo");

  tarapotoDiv.innerHTML = `<h2>Resultados SAT Tarapoto</h2><div class="tarjeta"><div class="loader"></div></div>`;
  huancayoDiv.innerHTML = `<h2>Resultados SAT Huancayo</h2><div class="tarjeta"><div class="loader"></div></div>`;

  try {
    const res = await fetch("/api/consultar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa })
    });

    const data = await res.json();

    // Tarapoto
    if (Array.isArray(data.tarapoto)) {
      tarapotoDiv.innerHTML = `<h2>Resultados SAT Tarapoto</h2>` + generarTablaProvincias(data.tarapoto);
    } else {
      tarapotoDiv.innerHTML = `<h2>Resultados SAT Tarapoto</h2><div class="mensaje-infoo">‚ÑπÔ∏è ${data.tarapoto}</div>`;
    }

    // Huancayo
    if (Array.isArray(data.huancayo)) {
      huancayoDiv.innerHTML = `<h2>Resultados SAT Huancayo</h2>` + generarTablaProvincias(data.huancayo);
    } else {
      huancayoDiv.innerHTML = `<h2>Resultados SAT Huancayo</h2><div class="mensaje-infoo">‚ÑπÔ∏è ${data.huancayo}</div>`;
    }

  } catch (err) {
    tarapotoDiv.innerHTML = `<h2>Resultados SAT Tarapoto</h2><div class="mensaje-error">‚ùå Error al consultar.</div>`;
    huancayoDiv.innerHTML = `<h2>Resultados SAT Huancayo</h2><div class="mensaje-error">‚ùå Error al consultar.</div>`;
  }
}

function generarTablaProvincias(datos) {
  let html = `<div class="tabla-responsive"><table>
    <tr><th>N¬∞</th><th>Placa</th><th>Infracci√≥n</th><th>Fecha</th><th>Estado / Monto</th></tr>`;
  
  datos.forEach(d => {
    html += `<tr>
      <td>${d.numero || ''}</td>
      <td>${d.placa || ''}</td>
      <td>${d.infraccion || ''}</td>
      <td>${d.fecha || ''}</td>
      <td>${d.estado || d.monto || ''}</td>
    </tr>`;
  });

  html += `</table></div>`;
  return html;
}
async function consultarATU(placa) {
  const atuDiv = document.getElementById("resultado-atu");
  atuDiv.innerHTML = `<h2>üöå Consulta ATU </h2><div class="tarjeta"><div class="loader"></div>`;
 
  try {
    const res = await fetch("/api/atu", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa })
    });

    const data = await res.json();

    if (!data.registrado) {
      atuDiv.innerHTML = `<h2>üöå Consulta ATU</h2><div class="mensaje-infoo">${data.mensaje || "‚ÑπÔ∏è Placa no registrada en ATU."}</div>`;
      return;
    }

    const html = `
      <div class="tarjeta">
        <p><strong>Placa:</strong> ${data.vehiculo.placa}</p>
        <p><strong>Modalidad:</strong> ${data.vehiculo.modalidad}</p>
        <p><strong>Marca:</strong> ${data.vehiculo.marca}</p>
        <p><strong>Modelo:</strong> ${data.vehiculo.modelo}</p>
        <p><strong>Circulaci√≥n:</strong> ${data.vehiculo.circulacion}</p>
        <p><strong>Estado:</strong> ${data.vehiculo.estado}</p>
        <hr>
        <p><strong>N¬∞ Constancia:</strong> ${data.tarjeta.numero}</p>
        <p><strong>Fecha Emisi√≥n:</strong> ${data.tarjeta.fecha_emision}</p>
        <p><strong>Fecha Vencimiento:</strong> ${data.tarjeta.fecha_vencimiento}</p>
        <hr>
        <p><strong>Documento Titular:</strong> ${data.titular.documento}</p>
        <p><strong>Ruta:</strong> ${data.titular.ruta}</p>
        <p><strong>Titular:</strong> ${data.titular.nombre}</p>
      </div>
    `;

    atuDiv.innerHTML = `<h2>Consulta ATU</h2>${html}`;

  } catch (error) {
    atuDiv.innerHTML = `<h2>Consulta ATU</h2><div class="mensaje-error">‚ÑπÔ∏è Placa no registrada en ATU..</div>`;
  }
}
function cargarImagenBase64(url) {
  return fetch(url)
    .then(res => res.blob())
    .then(blob => new Promise(resolve => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    }));
}

async function descargarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

  let y = 20;

  // -------- Logo y encabezado ----------
  const logo = new Image();
  logo.src = "principal.png";
  await new Promise(resolve => logo.onload = resolve);
  doc.addImage(logo, "PNG", 15, y, 30, 20);
  y += 25;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.setTextColor(33, 37, 41);
  doc.text("Consulta Vehicular Integral", 105, y, null, null, "center");
  y += 8;

  const fecha = new Date().toLocaleString("es-PE");
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text(`Fecha de consulta: ${fecha}`, 105, y, null, null, "center");
  y += 5;

  doc.setLineWidth(0.3);
  doc.setDrawColor(180);
  doc.line(10, y, 200, y);
  y += 10;

  // -------- Funciones internas ----------
  function limpiarTexto(texto) {
    return texto
      .replace(/<br\s*\/?>/gi, "\n")
      .replace(/<\/?[^>]+(>|$)/g, "")
      .replace(/[^\x20-\x7E\n\r]/g, "")
      .trim();
  }

  async function cargarImagenComoBase64(url) {
    try {
      const response = await fetch(url);
      const blob = await response.blob();
      return await new Promise(resolve => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    } catch (e) {
      console.error("Error cargando imagen:", e);
      return null;
    }
  }

  async function agregarSeccion(titulo, elementoHTML, color = [245, 245, 245]) {
    if (!elementoHTML) return;
    const textoPlano = limpiarTexto(elementoHTML.innerText);
    if (!textoPlano) return;

    doc.setFillColor(...color);
    doc.setDrawColor(220);
    doc.roundedRect(10, y, 190, 10, 2, 2, "F");

    doc.setFontSize(13);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0, 102, 204);
    doc.text(titulo, 15, y + 7);

    y += 14;

    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(33, 37, 41);

    const lineas = doc.splitTextToSize(textoPlano, 180);
    const startY = y;

    for (const line of lineas) {
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
      doc.text(line, 15, y);
      y += 6;
    }

    // Im√°genes dentro
    const imgTag = elementoHTML.querySelector("img");
    if (imgTag) {
      const imgData = await cargarImagenComoBase64(imgTag.src);
      if (imgData) {
        if (y > 220) {
          doc.addPage();
          y = 20;
        }
        doc.addImage(imgData, "JPEG", 60, y, 90, 50);
        y += 55;
      }
    }

    // Borde externo
    doc.setDrawColor(220);
    doc.roundedRect(10, startY - 14, 190, y - startY + 24, 2, 2, "S");

    y += 10;
  }

  // -------- Funci√≥n para provincias ----------
  async function agregarCiudad(ciudad, texto) {
  if (!texto) return;

  // Limpiar caracteres raros (ahora permite UTF-8 completo con tildes y √±)
  texto = texto
    .normalize("NFC")
    .replace(/[^\w√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±.,:;¬°!¬ø?\s-]/g, "")
    .trim();

  const lineas = doc.splitTextToSize(texto, 180);
  const alturaLinea = 6;
  const padding = 4;
  const alturaTarjeta = lineas.length * alturaLinea + padding * 2;

  if (y + alturaTarjeta > 280) {
    doc.addPage();
    y = 20;
  }

  // üîµ Ahora solo azul/gris, nunca rojo
  let color = (ciudad.length % 2 === 0) ? [235, 245, 255] : [245, 245, 245]; // azul muy clarito
  // si quieres alternar entre gris y azul, puedes usar algo as√≠:
   
  doc.setFillColor(...color);
  doc.setDrawColor(200);
  doc.roundedRect(10, y, 190, alturaTarjeta, 2, 2, "FD");

  // Subt√≠tulo ciudad
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.setTextColor(0, 102, 204);
  doc.text(`üìç ${ciudad}`, 15, y + 6);

  // Texto de contenido
  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.setTextColor(33, 37, 41);

  let textY = y + 12;
  for (const line of lineas) {
    doc.text(line, 15, textY);
    textY += alturaLinea;
  }

  y += alturaTarjeta + 6;
}
  // -------- Secciones fijas ----------
  const secciones = [
    { titulo: "SOAT", id: "soat-info", color: [230, 245, 255] },
        { titulo: "Impuesto Vehicular(SAT)", id: "resultado-impuesto", color: [240, 250, 255] },
    { titulo: "Datos del Veh√≠culo", id: "vehiculo-info", color: [240, 250, 255] },
    { titulo: "SAT Lima", id: "resultado-lima", color: [235, 245, 255] },
    { titulo: "SAT Callao", id: "resultado-callao", color: [240, 250, 255] },
    { titulo: "SAT Tarapoto", id: "resultado-tarapoto", color: [230, 240, 250] },
    { titulo: "SAT Huancayo", id: "resultado-huancayo", color: [240, 250, 255] },
    { titulo: "ATU", id: "resultado-atu", color: [230, 240, 255] },
    { titulo: "Revisi√≥n T√©cnica MTC", id: "resultado-revision", color: [235, 245, 255] },
    { titulo: "Infogas GNV", id: "resultado-infogas", color: [240, 250, 255] },
    { titulo: "Resultados SBS (Siniestros)", id: "resultadoSiniestro", color: [240, 250, 255] },
    { titulo: "Resultados SUTRAN", id: "resultadoSutran", color: [240, 250, 255] },
    { titulo: "Resultados SAT √ìrdenes de Captura (Gravamen)", id: "resultadoOrdenCaptura", color: [240, 250, 255] },
    { titulo: "Resultados SAT Piura", id: "resultado-piura", color: [240, 250, 255] },
    { titulo: "Resultados SAT Tacna", id: "resultado-tacna", color: [240, 250, 255] },
     { titulo: "Resultados SAT Arequipa", id: "resultado-arequipa", color: [240, 250, 255] }
         
  ];

  for (const s of secciones) {
    const el = document.getElementById(s.id);
    if (el) await agregarSeccion(s.titulo, el, s.color);
  }
// -------- Procesar provincias --------
const resultadoDiv = document.getElementById("resultado");
if (resultadoDiv) {
  const hijos = resultadoDiv.querySelectorAll(".result-box"); // cada provincia que creaste en tu fetch
  for (const box of hijos) {
    const titulo = box.querySelector("h2")?.innerText.trim() || "Provincia";

    // Clonar contenido SIN el h2
    let texto = "";
    box.childNodes.forEach((nodo) => {
      if (!(nodo.tagName && nodo.tagName.toLowerCase() === "h2")) {
        texto += nodo.innerText ? nodo.innerText.trim() + "\n" : "";
      }
    });

    // üîπ Limpieza extra
    texto = texto
      .normalize("NFC")
      .replace(/^[^a-zA-Z0-9√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±]+/, "") // üöÄ borra cualquier cosa rara al inicio
      .replace(/[\u0000-\u001F\u007F-\u009F]/g, "") // borra caracteres invisibles
      .trim();

    // Eliminar espacios m√∫ltiples y normalizar saltos de l√≠nea
    texto = texto.replace(/\s{2,}/g, " ").replace(/\n{2,}/g, "\n");

    await agregarCiudad(titulo, texto);
  }
}
  // -------- Descargar PDF ----------
  doc.save("consulta-vehicular.pdf");
}

 sessionStorage.removeItem("yaConsultado");

 
const resultadoo = document.getElementById("resultado-PROPIETARIOS");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modal-body");
const modalClose = document.querySelector(".modal-close");

function mostrarCargando() {
  resultadoo.innerHTML = `
    <div class="loading-container">
      <div class="spinner"></div>
      <p class="loading-message">Consultando, por favor espere...</p>
    </div>
  `;
  setTimeout(() => {
    const msg = resultadoo.querySelector(".loading-message");
    if (msg) msg.textContent = "Ya est√° casi listo...";
  },11000);
  setTimeout(() => {
    const msg = resultadoo.querySelector(".loading-message");
    if (msg) msg.textContent = "Extrayendo la informaci√≥n...";
  }, 16000);
}

document.getElementById("formConsulta").addEventListener("submit", async (e) => {
  e.preventDefault();
    
 
  if (sessionStorage.getItem("yaConsultadoPropietario")) {
    alert("Solo se permite una consulta por sesi√≥n en Consulta Propietario.");
    return;
  }
  sessionStorage.setItem("yaConsultadoPropietario", "true");

  const placa = document.getElementById("placaa").value.trim();
  const ciudad = document.getElementById("ciudad").value.trim();

  mostrarCargando();

  try {
    const res = await fetch("http://localhost:3000/api/asientos", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ placa, ciudad })
    });
    if (!res.ok) throw new Error("Error en la consulta");

    const data = await res.json();
    resultadoo.innerHTML = "";

    if (!data || !data.asientos || data.asientos.length === 0) {
      resultadoo.innerHTML = "<p style='text-align:center;'>‚ùå No se encontraron asientos.</p>";
      return;
    }

    const contenedor = document.createElement("div");
    contenedor.className = "contenedor-asientos";
    resultadoo.appendChild(contenedor);

    const headerDiv = document.createElement("div");
    headerDiv.className = "cabecera";
    headerDiv.innerHTML = `
      <h3>${data.header.orden}</h3>
      <p><strong>${data.header.partida}</strong></p>
      <p><strong>${data.header.paginas}</strong></p>
    `;
    contenedor.appendChild(headerDiv);

    const listaDiv = document.createElement("div");
    listaDiv.className = "lista-asientos";
    contenedor.appendChild(listaDiv);

    data.asientos.forEach((a, i) => {
      const div = document.createElement("div");
      div.className = "asiento";
      div.innerHTML = `
        <p>üìå <strong>T√≠tulo</strong>: ${a.titulo}</p>
        <p>üî¢ <strong>Nro. Asiento</strong>: ${a.nroAsiento}</p>
        <p>üìã <strong>Acto</strong>: ${a.acto}</p>
        <p>üìÖ <strong>A√±o</strong>: ${a.anio}</p>
        <p>üìñ <strong>P√°ginas</strong>: ${a.paginas}</p>
        <span class="btn-info" data-index="${i}">‚ÑπÔ∏è</span>
      `;
      listaDiv.appendChild(div);
    });
// Despu√©s de crear los divs de los asientos
const descargarBtn = document.createElement("button");
descargarBtn.textContent = "üìÑ Descargar PDF";
descargarBtn.className = "btn-descargar";
descargarBtn.style.display = "block";
descargarBtn.style.margin = "20px auto"; // centrar bot√≥n
descargarBtn.addEventListener("click", () => {
  generarPDF(data);
});
resultadoo.appendChild(descargarBtn);

// Funci√≥n para generar PDF mejorado
function generarPDF(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  let y = 20;
  const margin = 10;
  const lineHeight = 6;

  // üîπ Cabecera
  doc.setFontSize(18);
  doc.text("Consulta de Asientos SUNARP", pageWidth / 2, y, { align: "center" });
  y += 8;
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageWidth - margin, y);
  y += 10;

  // üîπ Informaci√≥n de cabecera
  doc.setFontSize(12);
  doc.text(`Orden: ${data.header.orden}`, margin, y);
  y += lineHeight;
  doc.text(`Partida: ${data.header.partida}`, margin, y);
  y += lineHeight;
  doc.text(`P√°ginas: ${data.header.paginas}`, margin, y);
  y += 10;

  // üîπ Asientos
  data.asientos.forEach((a, i) => {
    // Verificar si caben en la p√°gina, si no agregar nueva
    if (y + 40 > pageHeight - margin) {
      doc.addPage();
      y = 20;
    }

    // Tarjeta asiento
    const tarjetaHeight = 35;
    doc.setFillColor(240, 240, 240);
    doc.rect(margin, y, pageWidth - 2*margin, tarjetaHeight, 'F');

    doc.setFontSize(14);
    doc.text(`Asiento ${i + 1}: ${a.titulo}`, margin + 2, y + 8);

    doc.setFontSize(11);
    doc.text(`Nro: ${a.nroAsiento}`, margin + 2, y + 14);
    doc.text(`Acto: ${a.acto}`, margin + 2, y + 20);
    doc.text(`A√±o: ${a.anio}`, margin + 2, y + 26);
    doc.text(`P√°ginas: ${a.paginas}`, pageWidth / 2, y + 14);

    y += tarjetaHeight + 5;

    // üîπ Detalles en tabla
    if (a.detalles) {
      for (let key in a.detalles) {
        if (y + lineHeight > pageHeight - margin) {
          doc.addPage();
          y = 20;
        }
        doc.text(`${key}: ${a.detalles[key]}`, margin + 4, y);
        y += lineHeight;
      }
      y += 4;
    }
  });

  // üîπ Guardar PDF
  doc.save("consulta_asientos.pdf");
}
    // Evento para abrir modal
    document.querySelectorAll(".btn-info").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const idx = e.target.dataset.index;
        const detalles = data.asientos[idx].detalles || {};
        let html = "<table>";
        for (let key in detalles) {
          html += `<tr><td><b>${key}</b></td><td>${detalles[key]}</td></tr>`;
        }
        html += "</table>";
        modalBody.innerHTML = html;
        modal.style.display = "flex";
      });
    });

  } catch (err) {
    console.error(err);
    resultadoo.innerHTML = "<p style='text-align:center;'>‚ö†Ô∏è Error al obtener asientos</p>";
  }
});

// Cerrar modal
modalClose.addEventListener("click", () => modal.style.display = "none");
modal.addEventListener("click", (e) => {
  if (e.target === modal) modal.style.display = "none";
});
 
  window.addEventListener("error", function (e) {
    console.error("üëâ Error atrapado:", e.error);
  });
  function compartirWhatsApp() {
  const placa = document.getElementById("placa").value.trim().toUpperCase();

  if (!placa) {
    alert("Por favor, ingresa una placa para compartir.");
    return;
  }

  const mensaje = `Hola, consulta vehicular para la placa *${placa}*: https://www.consultavehicular.services/?placa=${placa}`;
  const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(mensaje)}`;

  window.open(url, "_blank");
}     
function openTab(evt, tabName) {
  // Ocultar todos los contenidos
  const tabcontent = document.getElementsByClassName("tab-content");
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
    tabcontent[i].classList.remove("active");
  }

  // Quitar la clase "active" de los botones
  const tablinks = document.getElementsByClassName("tab-btn");
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].classList.remove("active");
  }

  // Mostrar el tab seleccionado
  document.getElementById(tabName).style.display = "block";
  document.getElementById(tabName).classList.add("active");

  // Activar el bot√≥n
  evt.currentTarget.classList.add("active");
}


</script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>